{
  "hash": "6b0a25c2d564cb93c9f29a6eaf9e551e",
  "result": {
    "markdown": "# Survival\n\nWith survival analysis we aim to model lifetimes or populations. Survival analysis is unique as it aims to include censoring.\n\nhttps://www.youtube.com/watch?v=7_XK7mGMm1E&list=PLoROMvodv4rOzrYsAxzQyHb8n_RWNuS1e&index=79\n\n\n## Chapter 1 - Intro\n\nWe are interested in two types of cencoring\n\n- right : The failure occurs after a set time, died after trial\n- left : The failure occurs before the observations begin, died before trial starts\n\nThe fundamental probaility theory required is as follows\n\n### Distribution Function\n\nLet $T$ be the failure time, where $T>0$. Then as expected the distribution function is:\n\n$F(t) = P(T\\leq t)$\n\nAnd therefore the probability density is:\n\n$f(t) = F'(t)$\n\nAnd so\n\n$F(t) = \\int_0^tf(u)du$\n\n\n### Survivor Function\n\nGenerally we are interested in whether someone will survive longer than a certain time. So:\n\n$S(t) = P(T\\geq t) = 1 - F(t) = \\int^{\\infty}_t f(u) du$\n\nAs it is linked to the distribution function we can therefore say\n\n$f(t) = -S'(t)$\n\n### Hazard Function\n\nThe risk of death at time $t$ given survival to time $t$. Or the instantaenous risk of death at time $t$\n\n$h(t) = \\frac{f(t)}{S(t)}$\n\n### Integrated Hazard Function\n\n$H(t) = \\int^{t}_0 h(u) du = -log(S(t))$\n\nSo\n\n$S(t) = e^{\\left(-H(t)\\right)}$\n\nand\n\n$f(t) = h(t)e^{\\left(-H(t)\\right)}$\n\n\n\n### Limits worth knowing\n\n$f(t) = lim_{h \\rightarrow 0 } \\frac{P(t < T < t+h)}{h}$\n\nand\n\n$h(t) = lim_{h \\rightarrow 0 } \\frac{P(t \\leq T < t+h | T \\geq t)}{h}$\n\n## Chapter 2 - Distributions\n\n### Exponential\n\nThe only distribution with a constant hazard function.\n\n$T_i \\sim Exp(\\lambda, \\gamma)$\n\nProperty| equation\n-----|-----\n$f(t)$|$\\lambda e^{-\\lambda t}$\n$F(t)$|$1 - e^{-\\lambda t}$\n$S(t)$|$e^{-\\lambda t}$\n$h(t)$ | $\\lambda$\n\n\n### Weibull\n\nThe weibull can vary by implementation `survreg` uses the following implementation\n\n$T_i \\sim Weibull(\\lambda, \\gamma)$\n\nProperties should be given, **TO BE VERIFIED**\n\nIn this course:\n\n- $\\lambda$ is the shape\n- $\\gamma$ is the rate\n\nIt is extremely flexible, but can become unstable near $\\gamma = 1$. From $\\gamma$ we know the following:\n\n- $\\gamma = 1$ - Constant Hazard, becomes the exponential\n- $\\gamma > 1$ - Hazard INCREASES with time\n- $\\gamma < 1$ - Hazard DECREASES with time\n\n\n**TODO - Add plot to get a feel for various hazrds, etc**\n\n::: {.cell execution_count=1}\n``` {.python .cell-code}\nfrom scipy import stats\nimport numpy as np\nimport matplotlib.pyplot as plt\n\nxs = np.arange(0,100,0.1)\ns_t = stats.expon(0,10).sf(xs)\nf_t = stats.expon(0,10).pdf(xs)\nplt.plot(xs,s_t)\n```\n\n::: {.cell-output .cell-output-display}\n![](survival_files/figure-html/cell-2-output-1.png){width=571 height=411}\n:::\n:::\n\n\n## Chapter 2 - Life Tables\n\nSee notes - Two example type to be practiced exhaustively (No loss and loss to follow up)\n\nLifetables tabulate death rates over a period of time. They are useful non-parametric summaries and help to inform which parametric models might be sensible. \n\nIn the loss to follow up we assume in this course that:\n\n- $p_x$ and $q_x$ are constant over a time period, this is reasonable if short\n- We assume those who withdraw have the same probability of dieing as those who don't\n- We assume withdrawls are evenly spaced through the year\n\nTODO: Finalise life tables with method.\n\n## Chapter 2.4 - Kaplan-Meier\n\nLife tables are just summaries. They result in a loss of alot of information as the bin dates. Kaplan-Meir is more useful if you have access to the raw data.\n\nThe full name of this chapter is the \"Kaplan-Meier Product Limit Estimate of S(t)\"\n\n> This can be practised endlessly using `survfit`\n\n### No Censoring\n\nNote - The somewhat obscure inclusion of at risk becomes clear when you include censored values.\n\nIf there are $n$ observed times to failures ($t_i$) we can order the times (provided there are k distinct). So \n\n$t_1, t_2, ... t_n$ becomes $t_{(1)} < t_{(2)} < ... < t_{(k)}$. If $d_i$ is the number of deaths at time $t_{(i)}$ then :\n\n$\\sum_{i=1}^k d_i = n$ \n\nIf we knwo this then we can estimate the CDF by:\n\n$\\hat{F}(t) = \\text{Proprtion of lifetimes that are} < t$\n\nSo if we are given a time $t$ to calculate we can use the following equation to approximate:\n\n$\\frac{1}{n} \\sum^{s}_{i=1}d_i$ where $t_s\\leq t \\leq t_{s+1}$\n\nSo as $\\hat{S}(t) = 1 - \\hat{F}(t)$  we can easily calc by \n\n$1 - \\frac{1}{n} \\sum^{s}_{i=1}d_i = \\frac{n - \\sum^{s}_{i=1}d_i }{n}$ \n\nA useful trick however is to consider $r_j$ those \"at risk\" (those who are still alive) just before time $t_j$. Just before $t_j$ we know that $r_{j+1} = r_j - d_j$. In lay terms the number at risk next is the number who were previoulsy at risk less those who just died.\n\nBy a telescoping series like effect it can be shown that (notice trailing numerator cancel leading denominator)\n\n$\\hat{S}(t) = \\frac{n-d_1}{n} \\times \\frac{n-d_1 - d_2}{n - d_1} \\times \\frac{n-d_1 - d_2- d_3}{n - d_1 - d_2} \\times ... \\times \\frac{n - d_1 - ... - d_s}{n - d_1 - ... - d_{s-1}}$\n\nAt risk $r$ can now be incorperated. as \n\n$\\hat{S}(t) = (1 - \\frac{d_1}{r_1}) \\times (1 - \\frac{d_2}{r_2}) \\times ... \\times (1 - \\frac{d_s}{r_s})$\n\nSimuplifying by notation therefore:\n\n$\\hat{S}(t) = \\prod^s_{j=1}( 1 - \\frac{d_j}{r_j})$ for $t_s\\leq t \\leq t_{s+1}$\n\nIt must hold that $s\\geq 1$ and anything before then is assume to equal 1. If everyone dies then the KP curve will go to zero.\n\n### With Censoring\n\nBecause we have included the at risk aspecty, censoring is treated in a very similar way except the at risk aspect is modified.\n\nTo calculate those at risk just before time $t$ we need to know who was cencosred. We introduce an $I_j$ term which is the number of people censored in the time interval $t_{j-1} \\leq t \\leq t_j$\n\n$r_1 = n - I_1$\n\nMore generally \n\n$r_j = r_{j-1} - d_{j-1} - I_j$\n\n### Calculating median S(t) with KM\n\nThe median survival time is the smallest value of time where the survivor function takes a value of 0.5 or less. \n\nSo for instance in your Kaplan-Meier table you have a something like this\n\ntime | S(t)\n----|-----\n4|0.55\n8|0.47\n\nThen the median survival time is 8\n\n### Notes\n\n- KM relies on short intervals for recording death, if not completely continuous. It will not work for things like lifetables\n- If uncencorsed $I_j$ is always 0 so you get the same thing again\n- If the last observation(s) are censcored then the KM curve never reaches 0 but carries on forever. Obviously this isn't real and so becomes biased if the last observation(s) are censored. \n- Greenwoods provides a formula for sampling error $var(\\hat{S}(t)) = (\\hat{S}(t))^2 \\sum^s_{j=1} \\frac{d_j}{r_j(r_j - d_j)}$ for $t_s\\leq t \\leq t_{s+1}$\n- Hazard can also be calculated as $\\hat{H}(t) = -log\\hat{S}(t)$. A simplae approiximation for hazard can be shown to be $H(t) \\approx \\sum_{j-1}^s\\frac{d_j}{r_j}$\n\n### Exam method\n\n> This can be practised endlessly using `survfit`\n\nTODO: COMPLETE THIS AFTER SIME PRACTICE \n\n1) Create a j col from 0 .... to number of unique death timestamp\n2) List all unique deaths in $t_{(j)}$ column. DO NOT INCLUDE CENSOR TIMES\n3) Leave 0 row blank with exception of \\hat{S(t)} column, set that to 1.\n4) At risk column \n\n## Chapter 2.5 - Parametric \n\nTODO : In this I largely gloss over the likelihood stuff. It feels unlikely it will be examined and I will retun if time.\n\nThis chapter assumes an exponetial distribution $T \\sim Exp(\\lambda)$ is being used.\n\nWhen doing likelihood for uncensored data you follwo the usual path of finding the Likelihood by multiplying through, get log likelihood if convinient and differentiating with respect to the paramater. So \n\n$L(\\lambda ; t_1, t_2 ... t_n) = \\prod^n_{i=1}f(t_i)$\n\nIn the censored case however this becomes a little more complicated. You cannot just multiply by the desnities as you do not know the density for the censored values.\n\nIf we observed a death then $f(t)$ contributes to the likelihood. However if we do not observed the death $t_i > c_i$ then we say that we know they survived longer than some time so $P(T > c_i) = S(c_i)$. And this contributes to the likelihood.\n\nBy combining density and survivor functions and applying the indicator 0=censor, 1=death. The following form of the likelihood can be created:\n\n$L(\\lambda) = \\prod_{i=1}^n f(t_i)^{\\delta_i}S(c_i)^{1-\\delta_i} = $\n\n$L(\\lambda) = \\prod_{i=1}^n [\\lambda e^{-\\lambda t_i}]^{\\delta_i}[e^{-\\lambda c_i}]^{1-\\delta_i}$\n\nIt can then be shown that:\n \n$\\hat{\\lambda} = \\frac{\\sum^n_{i=1} \\delta_i}{\\sum^n_{i=1}(t_i\\delta_i +(1-\\delta_i)c_i)}$\n\nAnd \n\n$var(\\hat{\\lambda}) \\approx \\frac{\\hat{\\lambda}^2}{\\sum^n_{i=1} \\delta_i}$\n\nBy asymptopic normality of the MLE the 95% CI is $\\hat{\\lambda}\\pm 1.96\\sqrt{var(\\hat{\\lambda}}$\n\nFor the exponential we calculate the mean by $\\frac{1}{var(\\hat{\\lambda})}$ and the variance of this can be shown to be \n\n$var(\\hat{\\mu}) = \\frac{\\hat{\\mu}^2}{\\sum_{i=1}^n \\delta_i}$\n\nTODO: What is the value in learning equation 56/61 with exp denom.\nTODO: RAndom censoring, log normal and others (2.5.6)\n\n### Using R - Exponetial\n\nThe exponetial model can be fitted in r with `survreg`, where `dist='exponential'`.\n\nFor the MLE of $\\hat{\\lambda}$ you take $exp(-\\beta_0)$ assuming no covariates  eg `time ~ 1`. The easiest way to get the CI is to apply +/- 1.96 standard error to beta pre exponent. This will give some minor disagreement though to the division by death count method.\n\n>$\\hat{\\lambda} = exp(-\\hat{\\beta_0} \\pm 1.96\\times se(\\hat{\\beta_0}))$\n\n\n### Using R - Weibull\n\nUnder the weibull again $\\hat{\\lambda} = exp(-\\hat{\\beta_0} \\pm 1.96\\times se(\\hat{\\beta_0}))$ and $\\hat{\\gamma} = \\frac{1}{\\text{scale}}$\n\nThe weibull is summarised in our work as $T \\sim Weibull(\\lambda, \\gamma)$\n\nWhen $\\gamma = 1$ we are left with the exponential distribution.\n\n### Workflow:\n\n1. fit a kaplan-meier. Is the decay expoenntial? then exp could make sense\n\n\n\n\n## Chapter 3  - Two Sample\n\nKaplan-Meier is just a visual aid, we need to look at tests\n\n### Log Rank Test\n\nNon-parametric.\n\n\n$$ H_0 : S_1(t) = S_2(t)$$\n\n$$ H_A : S_1(t) \\neq S_2(t)$$ \n\n$H_A$ is for some $t$\n\nSteps:\n\n1) Create a table\n2) create an $i$ column for 1,2,..n\n3) create a $t_i$ column and list all the times of deaths only\n4) Create an $r_{1,i}$ and $r_{2,i}$ for at risk (At risk for a time includes those who died at that time and all future censorees)\n5) Sum  $r_{1,i}$ and $r_{2,i}$ to get $r_i$\n6) Create an $d_{1,i}$ and $d_{2,i}$ for death counts at the times\n7) Sum the deaths to get $d_i$\n8) Sum down death column to get observed $O_1$ and $O_2$\n9) Calc $e_{1,i} = (\\frac{r_{1,i}}{r_i})d_i$ and $e_{2,i}$\n10) Sum the $e_{1,i}$ and $e_{2,i}$ to get $E_1$ and $E_2$\n11) Calculate using below equation\n\n$$ LR = \\frac{(O_1 - E_1)^2}{E_1} + \\frac{(O_2 - E_2)^2}{E_2} \\sim \\chi^2_{1}$$\n\nTo perform the logrank in r perform the following `survdiff(formula = 'time ~ treatment')`\n\n### Parametric \n\nThere are two types of parametric methods of interest MLE test and Likelihood ratio\n\n### MLE Test\n\nEffectively looks at the paramters as normally distributed (though any test, distribution is applicable). Then performs standard tests upon them. So in the case of lambda, given it is normally distributed as an estimator.\n\n$\\frac{\\hat{\\lambda}_1 - \\hat{\\lambda}_2}{\\sqrt{\\frac{\\hat{\\lambda}_1^2}{\\Delta_1}-\\frac{\\hat{\\lambda}_2^2}{\\Delta_2}}} \\sim N(0,1)$\n\nHere $\\Delta$ is the number of deaths and $\\hat{\\lambda}$ is the number of deaths over total time (death and censor).\n\n### Likelihood Ratio\n\nIn formula sheet\n\nTODO: run through the proof\n\n### `Survreg`\n\nFrom survreg we can use the output of a two factor analysis to easily do a MLE test by taking the parameter and covariance matrix.\n\nFor LRT look at the following line near the bottom for the p-value.\n\nChisq=1.2 on 1 degrees of freedom , p=0.27\n\n",
    "supporting": [
      "survival_files"
    ],
    "filters": [],
    "includes": {}
  }
}